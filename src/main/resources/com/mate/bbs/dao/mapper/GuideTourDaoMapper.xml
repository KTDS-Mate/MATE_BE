<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.mate.bbs.dao.GuideTourDao">

<resultMap id="guideTourVOMap" 
		   type="com.mate.bbs.vo.GuideTourVO"
		   autoMapping="true">
		   <id column="GD_TR_PST_ID" property="gdTrPstId"/>
		   <association property="userVO"
		   				javaType="com.mate.user.vo.UserVO"
						autoMapping="true">
				<id column="USR_ID" property="usrId" />	
			</association>
			
			<association property="citiesVO"
						javaType="com.mate.common.vo.CitiesVO"
						autoMapping="true">
				<id column="CITY_ID" property="cityId"/>
			</association>
			
			<association property="countriesVO"
						javaType="com.mate.common.vo.CountriesVO"
						autoMapping="true">
				<id column="COUNTRY_ID" property="countryId"/>
			</association>
			
			
			
			<collection property="guideTourImgList" 
						ofType="com.mate.bbs.vo.GuideTourImgVO"
						autoMapping="true">
				<id column="GD_TR_IMG_ID" property="gdTrImgId"/>
			</collection>
			
			<collection property="guideTourDetailInfoList"
						ofType="com.mate.bbs.vo.GuideTourDetailInfoVO"
						autoMapping="true">
				<id column="TR_DTL_ID" property="trDtlId"/>
			</collection>
			
			<collection property="guideTourProvidedList"
						ofType="com.mate.bbs.vo.GuideTourProvidedVO"
						autoMapping="true">
				<id column="TR_INCLD_ID" property="trIncldId"/>
			</collection>
			
			 <collection property="guideTourReviewList"
						ofType="com.mate.bbs.vo.GuideTourReviewVO"
						autoMapping="true">
				<id column="GD_TR_RVW_ID" property="gdTrRvwId"/>
			</collection>
			
			
			
			<collection property="guideTourScheduleInfoList"
						ofType="com.mate.bbs.vo.GuideTourScheduleInfoVO"
						autoMapping="true">
				<id column="TR_ADD_INF_ID" property="trAddInfId"/>
			</collection>
		</resultMap>
	
	<select id="selectGuideTourAllCount" resultType="_int">
		SELECT COUNT(1)
		  FROM GD_TR_RCRT
	</select>
	
	<select id="selectOneGuideTour" 
			parameterType="string"
			resultMap="guideTourVOMap">
		SELECT GTR.GD_TR_PST_ID
			 , GTR.ATHR_ID
			 , GTR.USR_ID
			 , GTR.GD_TR_TTL
			 , GTR.GD_TR_MX_NP
			 , GTR.GD_TR_PRC
			 , GTR.GD_TR_SMRY
			 , TO_CHAR(GTR.GD_TR_ST_DT, 'YYYY-MM-DD HH24:MI') GD_TR_ST_DT 
			 , TO_CHAR(GTR.GD_TR_ED_DT, 'YYYY-MM-DD HH24:MI') GD_TR_ED_DT
			 , GTR.GD_TR_PRPS
			 , ATHR.GD_PRFL_IMG
			 , ATHR.USR_GNDR
			 , ATHR.USR_FNM 
			 , ATHR.USR_LNM 
			 , ATHR.USR_BD 
			 , ATHR.USR_GD_EXP
			 , TI.TR_INCLD 
			 , GTR.GD_TR_MP
			 , TSI.TR_DTL_LCT
			 , TSI.TR_DTL_SCHD 
			 , TD.TR_DTL_INF 
			 , GTR.GD_TR_RSTR_DT
			 , GTR.GD_TR_MDFY_DT
			 , GTR.GD_TR_DLT_DT
			 , GTR.GD_TR_IS_DLT
			 , GTR.TR_CT_ID
			 , GTRI.GD_TR_IMG_URL 
			 , TRUNC(MONTHS_BETWEEN(TRUNC(SYSDATE), ATHR.USR_BD) / 12) AS GUIDE_AGE
		  FROM GD_TR_RCRT GTR
		  LEFT JOIN GD_TR_RCRT_IMG GTRI
		    ON GTR.GD_TR_PST_ID = GTRI.GD_TR_PST_ID 
		  JOIN USR_INF ATHR
		    ON GTR.ATHR_ID = ATHR.USR_LGN_ID 
		  LEFT JOIN TOUR_INCLD TI
		    ON TI.GD_TR_PST_ID = GTR.GD_TR_PST_ID  
		  LEFT JOIN TR_DTL TD
		    ON TD.GD_TR_PST_ID = GTR.GD_TR_PST_ID
		  LEFT JOIN TR_SCHD_INF TSI
		    ON TSI.GD_TR_PST_ID = GTR.GD_TR_PST_ID
		  LEFT JOIN GD_TR_RVW GTRV
		    ON GTR.GD_TR_PST_ID = GTRV.GD_TR_PST_ID 
		  LEFT JOIN GD_TR_RVW_IMG GTRVI
		    ON GTRV.GD_TR_RVW_ID = GTRVI.GD_TR_RVW_ID 
		 WHERE GTR.GD_TR_PST_ID = #{_parameter}
	</select>
	
	<select id="selectAllGuideTour" 
			resultMap="guideTourVOMap"
			parameterType="com.mate.bbs.vo.SearchGuideTourVO">
	<if test="_parameter != null">
			<include refid="Common.pagination_header" />
	</if>
		SELECT GTR.GD_TR_PST_ID
			 , GTR.ATHR_ID
			 , GTR.USR_ID
			 , GTR.GD_TR_TTL
			 , GTR.GD_TR_ST_DT
			 , GTR.GD_TR_ED_DT
			 , GTR.GD_TR_PRPS
			 , GTR.GD_TR_MP
			 , GTR.GD_TR_PRC
			 , GTR.GD_TR_SMRY
			 , GTR.GD_TR_RSTR_DT
			 , GTR.GD_TR_MDFY_DT
			 , GTR.GD_TR_DLT_DT
			 , GTR.GD_TR_IS_DLT
			 , GTR.TR_CT_ID
			 , GTRI.GD_TR_IMG_URL
			 , GTR.GD_TR_MX_NP
			 , C.CITY_NAME 
			 , ( SELECT AVG(gtr2.GD_TR_RVW_RTNG)
			       FROM GD_TR_RVW gtr2
			 	  WHERE gtr2.GD_TR_PST_ID = GTR.GD_TR_PST_ID ) AS AVG_RVW
	     FROM GD_TR_RCRT GTR
	     LEFT JOIN GD_TR_RCRT_IMG GTRI
	       ON GTR.GD_TR_PST_ID = GTRI.GD_TR_PST_ID 
	     LEFT JOIN GD_TR_RVW GTRV
	       ON GTR.GD_TR_PST_ID = GTRV.GD_TR_PST_ID
	     JOIN CITIES C
	       ON C.CITY_ID = gtr.TR_CT_ID
	    ORDER BY GTR.GD_TR_PST_ID DESC
	    <if test="_parameter != null">
			<include refid="Common.pagination_footer" />
		</if>
	</select>
	<insert id="insertNewGuideTour" 
			parameterType="com.mate.bbs.vo.GuideTourWriteVO">
		<!--
		 PK를 먼저 발급 받음 
		 keyProperty : VO에서 PK를 담당하는 프로퍼티 작성
		 order : BEFORE - 쿼리를 실행하기 전에 먼저 실행
		 		 AFTER - 쿼리를 실행한 후 실행
		 resultType : 해당 쿼리의 반환 값
		-->
		<selectKey keyProperty="gdTrPstId" order="BEFORE" resultType="string">
			SELECT 'GT-' || TO_CHAR(SYSDATE, 'YYYYMMDD') || '-' || LPAD(SEQ_GD_TR_RCRT_PK.NEXTVAL, 6, 0)
			  FROM DUAL
		</selectKey>
		INSERT INTO GD_TR_RCRT
		 (GD_TR_PST_ID
		, ATHR_ID
		, USR_ID
		, GD_TR_TTL
		, GD_TR_ST_DT
		, GD_TR_PRPS
		, GD_TR_MP
		, GD_TR_PRC
		, GD_TR_SMRY
		, GD_TR_RSTR_DT
		, GD_TR_MDFY_DT
		, GD_TR_DLT_DT
		, GD_TR_IS_DLT
		, TR_CT_ID
		, GD_TR_ED_DT
		, GD_TR_MX_NP
		, GD_TR_STTS
		, TR_AVG_RTNG)
		VALUES
		 (#{gdTrPstId}
		, #{athrId}
		, NULL
		, #{gdTrTtl}
		, TO_DATE(SYSDATE, 'YYYY-MM-DD HH24:MI')
		, #{gdTrPrps}
		, NULL
		, 100
		, NULL
		, TO_DATE(SYSDATE, 'YYYY-MM-DD HH24:MI')
		, NULL
		, NULL
		, 'N'
		, 628
		, TO_DATE(#{gdTrEdDt}, 'YYYY-MM-DD HH24:MI')
		, 10
		, 'N'
		, NULL)
	</insert>
	<update id="updateGuideTour"
			parameterType="com.mate.bbs.vo.GuideTourModifyVO">
			UPDATE GD_TR_RCRT
			   SET GD_TR_TTL = #{gdTrTtl}
			   	 , GD_TR_ST_DT = TO_DATE(#{gdTrStDt}, 'YYYY-MM-DD HH24:MI')
			   	 , GD_TR_ED_DT = TO_DATE(#{gdTrEdDt}, 'YYYY-MM-DD HH24:MI')
			   	 , GD_TR_MDFY_DT = SYSDATE
			   	 , GD_TR_SMRY = #{gdTrSmry}
			   	 , GD_TR_PRC = #{gdTrPrc}
			   	 , GD_TR_PRPS = #{gdTrPrps}
			   	 , GD_TR_MP = #{gdTrMp}
			   	 , GD_TR_MX_NP = #{gdTrMxNp}
			 WHERE GD_TR_PST_ID = #{gdTrPstId}
	</update>
	<update id="updateGuideTourIsDtl"
			parameterType="string">
		UPDATE GD_TR_RCRT 
		   SET GD_TR_IS_DLT = 'Y'
		 WHERE GD_TR_PST_ID = #{_parameter}
	</update>
	
	<select id="selectAttachStartHour"
			parameterType="com.mate.bbs.vo.GuideTourWriteVO"
			resultType="string">
		SELECT #{inputYear} || ' ' || #{inputStartHour}
 		  FROM DUAL
	</select>
	
	<select id="selectAttachEndHour"
			parameterType="com.mate.bbs.vo.GuideTourWriteVO"
			resultType="string">
		SELECT #{inputYear} || ' ' || #{inputEndHour}
 		  FROM DUAL
	</select>
	
	<insert id="insertNewDetailInfo" 
			parameterType="com.mate.bbs.vo.GuideTourDetailInfoVO">
		INSERT INTO TR_DTL
		 (TR_DTL_ID
		, GD_TR_PST_ID
		, TR_DTL_INF)
		VALUES
		 ('DI-' || TO_CHAR(SYSDATE, 'YYYYMMDD') || '-' || LPAD(SEQ_TR_DTL_PK.NEXTVAL, 6, 0)
		, #{gdTrPstId}
		, #{trDtlInf})
	</insert>
	<insert id="insertNewSchdInfo"
			parameterType="com.mate.bbs.vo.GuideTourScheduleInfoVO">
		INSERT INTO TR_SCHD_INF
		 (TR_ADD_INF_ID
		, GD_TR_PST_ID
		, TR_DTL_LCT
		, TR_DTL_SCHD)
		VALUES
		 ('AI-' || TO_CHAR(SYSDATE, 'YYYYMMDD') || '-' || LPAD(SEQ_TR_SCHDL_PK.NEXTVAL, 6, 0)
		, #{gdTrPstId}
		, #{trDtlLct}
		, #{trDtlSchd})	
	</insert>
	<insert id="insertNewProvidedInfo"
			parameterType="com.mate.bbs.vo.GuideTourProvidedVO">
	 INSERT INTO TOUR_INCLD
		 (TR_INCLD_ID
		, TR_INCLD
		, GD_TR_PST_ID)
		VALUES
		 ('TI-' || TO_CHAR(SYSDATE, 'YYYYMMDD') || '-' || LPAD(SEQ_TOUR_INCLD_PK.NEXTVAL, 6, 0) 
		, #{trIncld}
		, #{gdTrPstId})
	</insert>
</mapper>